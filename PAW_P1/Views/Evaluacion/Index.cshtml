@{
    ViewBag.Title = "Evaluaciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Registro de Evaluaciones</h2>

<div class="row">
    <div class="col-md-6">
        <form id="formEvaluacion">
            <div class="form-group">
                <label>Estudiante</label>
                <select class="form-control" name="IdEstudiante" id="selectEstudiante" required></select>
            </div>

            <div class="form-group">
                <label>Curso</label>
                <select class="form-control" name="IdCurso" id="selectCurso" required></select>
            </div>

            <div class="form-group">
                <label>Nota</label>
                <input type="number" step="0.01" class="form-control" name="Nota" required />
            </div>

            <div class="form-group">
                <label>Participación</label>
                <input class="form-control" name="Participacion" />
            </div>

            <div class="form-group">
                <label>Estado</label>
                <input class="form-control" name="Estado" />
            </div>

            <div class="form-group">
                <label>Observaciones</label>
                <textarea class="form-control" name="Observaciones"></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Guardar</button>
            <span id="mensajeEvaluacion" class="text-info" style="margin-left:10px;"></span>
        </form>
    </div>

    <div class="col-md-6">
        <h3>Búsqueda</h3>
        <div class="form-inline" style="margin-bottom:10px;">
            <input id="entradaFiltroEvaluacion" class="form-control" placeholder="Estudiante o curso" style="width:70%;" />
            <button id="botonBuscarEvaluacion" class="btn btn-default" type="button">Buscar</button>
        </div>

        <table class="table table-striped" id="tablaEvaluaciones">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Estudiante</th>
                    <th>Curso</th>
                    <th>Nota</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <span id="mensajeBusquedaEvaluacion" class="text-info"></span>
    </div>
</div>

@section scripts{
    <script>
$(function () {

    function cargarSelect(url, $select, textoDefault) {
    $.get(url, function (res) {
        if (res.ok && res.data) {
        $select.empty().append('<option value="">Seleccione</option>');
        res.data.forEach(function (x) {
            var texto = x.Nombre || (x.Nombre + ' ' + (x.Apellidos || ''));
            $select.append('<option value="' + (x.IdEstudiante || x.IdCurso) + '">' + texto + '</option>');
        });
        } else {
            $select.empty().append('<option value="">Sin datos</option>');
        }
    });
    }

    cargarSelect('@Url.Action("Buscar","Estudiante")', $('#selectEstudiante'));
    cargarSelect('@Url.Action("Buscar","Curso")', $('#selectCurso'));

    var $form = $('#formEvaluacion');
    var $msg = $('#mensajeEvaluacion');

    // Registro con AJAX
    $form.on('submit', function (e) {
        e.preventDefault();
        var datos = new FormData(this);
        $.ajax({
            url: '@Url.Action("Crear","Evaluacion")',
            method: 'POST',
            data: datos,
            processData: false,
            contentType: false
        })
        .done(function (res) {
            if (res.ok) {
                $msg.removeClass('text-danger').addClass('text-success').text('Guardado. Id: ' + res.id);
                $form[0].reset();
                ejecutarBusquedaEvaluacion();
            } else {
                $msg.removeClass('text-success').addClass('text-danger').text('Error al guardar.');
            }
        })
        .fail(function () {
            $msg.removeClass('text-success').addClass('text-danger').text('Error de red.');
        });
    });

    var $inputFiltro = $('#entradaFiltroEvaluacion');
    var $btnBuscar = $('#botonBuscarEvaluacion');
    var $tbody = $('#tablaEvaluaciones tbody');
    var $msgBusq = $('#mensajeBusquedaEvaluacion');

    function ejecutarBusquedaEvaluacion() {
        var searchText = $inputFiltro.val() || '';
        $.get('@Url.Action("Buscar","Evaluacion")', { filtro: searchText }, function (res) {
            $tbody.empty();
            $msgBusq.text('');
            if (!res.ok || !res.data) {
                $msgBusq.addClass('text-danger').text('Sin resultados.');
                return;
            }
            console.log(res);
            res.data.forEach(function (ev) {
                $tbody.append(
                    '<tr><td>' + ev.IdEvaluacion + '</td>' +
                    '<td>' + (ev.NombreEstudiante || '') + '</td>' +
                    '<td>' + (ev.NombreCurso || '') + '</td>' +
                    '<td>' + ev.Nota + '</td>' +
                    '<td>' + (ev.Estado || '') + '</td></tr>'
                );
            });
            if (res.data.length === 0)
                $msgBusq.text('Sin resultados.');
        })
        .fail(function () {
            $msgBusq.addClass('text-danger').text('Error de red.');
        });
    }

    $btnBuscar.on('click', ejecutarBusquedaEvaluacion);
    $inputFiltro.on('keyup', ejecutarBusquedaEvaluacion);
    ejecutarBusquedaEvaluacion();
});
    </script>
}
